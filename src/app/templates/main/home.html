{% extends 'menu.html' %}

{% block header %}Home{% endblock %}
{% block info %}{% endblock %}

{% block content %}
<div id="generalOverview">
  <h2>General overview</h2>
  <div class="row" id="generalContent">
    <div class="board">
      <a>
        <h1>Calendar</h1>
        <div class="boardColumnContainer">
          <div class="boardSubTitle">
            <span id="today_date"></span>
          </div>
          {% if sun_times %}
          <div class="boardFlexItemU">
            sunrise: <span id="sunrise"></span> -
            sunset: <span id="sunset"></span>
          </div>
          {% endif %}
        </div>
      </a>
    </div>
    {% if current_weather %}
    <div class="board">
      <a href="{{ url_for('main.weather') }}">
        <h1>Current weather</h1>
        <div class="boardColumnContainer">
          <div class="weatherIcon" style="height: 115px; line-height: 115px; font-size: 70px;"><i id="weather_icon"></i></div>
          <div class="boardSubTitle">
            <span id="weather_summary"></span>
          </div>
          <div class="boardFlexItemU">
            Temperature: <span id="weather_temperature"></span>°C
          </div>
          <div class="boardFlexItemU">
            Wind: <span id="weather_windSpeed"></span>km/h
          </div>
          <div class="boardFlexItemU">
            Precipitation: <span id="weather_precipProbability"></span>%
          </div>
          <div class="boardFlexItemU">
            Humidity: <span id="weather_humidity"></span>%
          </div>
          <div class="boardFlexItemU">
            Cloud cover: <span id="weather_cloudCover"></span>%
          </div>
        </div>
      </a>
    </div>
    {% endif %}
    {% if current_user.can(Permission.ADMIN) %}
    <div class="board">
      <h1>Server info</h1>
      <div class="boardColumnContainer">
        <div class="boardSubTitle">Uptime</div>
        <div class="boardFlexItemU"><span id="server_uptime"></span></div>
        <div class="boardSubTitle" style="margin-top: 10px;">Average latency</div>
        <div class="boardFlexItemU">
          <span id="ping-pong">Na</span>ms
        </div>
        <div class="boardSubTitle" style="margin-top: 10px;">
          System utilization
        </div>
        <div class="boardFlexItemU">
          Average CPU load: <span id="server_CPU_used"></span>%
        </div>
        {% if current_system_data["CPU_temp"] %}
        <div class="boardFlexItemU">
            CPU temperature: <span id="server_CPU_temp"></span>°C
        </div>
        {% endif %}
        <div class="boardFlexItemU">
          RAM used:
            <span id="server_RAM_used"></span>GB /
            <span id="server_RAM_total"></span>GB
        </div>
        <div class="boardFlexItemU">
          Disk used:
            <span id="server_DISK_used"></span>GB /
            <span id="server_DISK_total"></span>GB
        </div>
      </div>
    </div>
    {% endif %}
    {% if current_user.is_authenticated %}
    <div class="board">
      <a href="{{url_for('main.warnings_')}}">
        <h1>Warnings overview</h1>
        <div class="boardColumnContainer">
          {% if warnings %}
          <table style="table-layout: auto; width: 100%; margin-top: 10px;">
            <tr>
              <th>Date</th>
              <th>!</th>
              <th>Title</th>
            </tr>
            {% for i in range(10) %}
            {% if warnings[i] %}
            <tr>
              <td><span id="warning_{{ i }}_datetime"></span></td>
              <td>{{ warnings[i].emergency }}</td>
              <td>{{ warnings[i].title }}</td>
            </tr>
            {% endif %}
            {% endfor %}
          </table>
          {% else %}
          <p style="margin-top: 10px">No warning</p>
          {% endif %}
        </div>
      </a>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
    <script type="text/javascript">
    socket.emit("subscribe", {channel: "home"});

    {% if sun_times %}
    // Calendar box
    let sunTimes = {{ sun_times | tojson }};

    function updateSunTimes() {
      for (const sunTime in sunTimes) {
        if (sunTimes.hasOwnProperty(sunTime)) {
          let sunTimeDT = new Date(sunTimes[sunTime]);
          $('#' + sunTime).text(sunTimeDT.toLocaleTimeString([], {timeStyle: "short"}));
        }
      }
    }

    updateSunTimes()

    socket.on('sun_times', function(msg) {
      sunTimes = msg;
      updateSunTimes()
    });
    {% endif %}

    {% if current_weather %}
    // Weather box
    let currentWeatherData = {{ current_weather | tojson }};
    const weatherDataFactors = {"temperature": 1, "windSpeed": 1, "precipProbability": 100, "humidity" : 100, "cloudCover": 100};

    function updateCurrentWeatherSpans() {
      $('#weather_summary').text(currentWeatherData["summary"]);
      let iconClass = utils.getWeatherIconClass(currentWeatherData["icon"]);
      $('#weather_icon').removeClass().addClass(iconClass);
      for (const parameter in weatherDataFactors) {
        if (weatherDataFactors.hasOwnProperty(parameter)) {
          $('#weather_' + parameter).text(Number(currentWeatherData[parameter] * weatherDataFactors[parameter]).toFixed(1));
        }
      }
    }

    updateCurrentWeatherSpans();

    socket.on('current_weather', function(msg) {
      currentWeatherData = msg;
      updateCurrentWeatherSpans()
    });
    {% endif %}

    {% if current_user.can(Permission.ADMIN) %}
    UI.injectHomeServerBoard()
    {% endif %}

    {% if current_user.is_authenticated %}
    // Warnings box
    warnings = {{ warnings | tojson }};

    function injectWarningDT(warningDT, i) {
      function formatWarningDT (DT) {
        return "".concat(DT.getDate(), "/", DT.getMonth(), " ", DT.toLocaleTimeString([], {timeStyle: "short"}));
      }
      $('#warning_' + i + '_datetime').text(formatWarningDT(warningDT));
    }

    for (let i = 0; i < warnings.length; i++) {
      let warningDT = new Date(warnings[i][0]);
      injectWarningDT(warningDT, i);
    }
    {% endif %}
    // Ecosystems boxes
    UI.injectHomeEcosystemBoards()
    </script>
{% endblock %}