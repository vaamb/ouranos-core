{% extends 'menu.html' %}

{% block header %}{% endblock %}
{% block info %}{% endblock %}

{% block content %}
          <div class="subtitleFix"></div>
          <h2>Global overview</h2>
          <div class="row">
            <div class="board" style="min-height: 255px;">
              <a>
                <div class="boardHeader">
                  Calendar
                </div>
                <div class="boardColumnContainer">
                  <div class="boardColumnTitle">
                    <span id="today_day"></span>
                  </div>
                  {% if sun_times %}
                  <div class="boardColumnItem">
                    sunrise: <span id="sunrise"></span> -
                    sunset: <span id="sunset"></span>
                  </div>
                  {% endif %}
                </div>
              </a>
            </div>
            {% if weather_data %}
            <div class="board" style="min-height: 255px;">
              <a href="{{ url_for('main.weather') }}">
                <div class="boardHeader">
                  Current weather
                </div>
                <div class="boardColumnContainer">
                  <!-- TODO: update weatherIcon when needed -->
                  <div class="weatherIcon" style="height: 115px; line-height: 115px; font-size: 70px;"><i class='{{weather_data["currently"]["icon"]|getWeatherIcon}}'></i></div>
                  <div class="boardColumnTitle" style="flex: 2">
                    <span id="weather_summary"></span>
                  </div>
                  <div class="boardColumnItem">
                    Temperature: <span id="weather_temperature"></span>°C
                  </div>
                  <div class="boardColumnItem">
                    Wind: <span id="weather_windSpeed"></span>km/h
                  </div>
                  <div class="boardColumnItem">
                    Precipitation: <span id="weather_precipProbability"></span>%
                  </div>
                  <div class="boardColumnItem">
                    Humidity: <span id="weather_humidity"></span>%
                  </div>
                  <div class="boardColumnItem">
                    Cloud cover: <span id="weather_cloudCover"></span>%
                  </div>
                </div>
              </a>
            </div>
            {% endif %}
            {% if current_user.is_administrator %}
            <div class="board" style="min-height: 255px;">
              <div class="boardHeader">
                Server info
              </div>
              <div class="boardColumnContainer">
                <div class="boardColumnTitle">Uptime</div>
                <div class="boardColumnItem"><span id="server_uptime"></span></div>
                <div class="boardColumnTitle" style="margin-top: 10px;">Average latency</div>
                <div class="boardColumnItem">
                  <span id="ping-pong">Na</span>ms
                </div>
                <div class="boardColumnTitle" style="margin-top: 10px;">
                  System utilization
                </div>
                <div class="boardColumnItem">
                  Average CPU load: <span id="server_CPU_used"></span>%
                </div>
                {% if system_data["CPU_temp"] %}
                <div class="boardColumnItem">
                    CPU temperature: <span id="server_CPU_temp"></span>°C
                </div>
                {% endif %}
                <div class="boardColumnItem">
                  RAM used:
                    <span id="server_RAM_used"></span>GB /
                    <span id="server_RAM_total"></span>GB
                </div>
                <div class="boardColumnItem">
                  Disk used:
                    <span id="server_DISK_used"></span>GB /
                    <span id="server_DISK_total"></span>GB
                </div>
              </div>
            </div>
            {% endif %}
            {% if current_user.is_authenticated %}
            <div class="board" style="min-height: 255px;">
              <a href="{{url_for('main.warnings_list')}}">
                <div class="boardHeader">
                  Warning overview
                </div>
                <div class="boardColumnContainer">
                  {% if warning %}
                  {% for w in warnings %}
                  <div class="boardColumnItem"></div>
                  {% endfor %}
                  {% endif %}
                </div>
              </a>
            </div>
            {% endif %}
          </div>

          {% if ecosystems %}
          <h2>Ecosystems overview</h2>
          <div>
            {% for ecosystem in ecosystems %}
            <div class="inlineBoard" style="min-height: 255px;">
              <div class="boardHeader" style="text-align: center;">
                {{ecosystems[ecosystem]["name"]}} &emsp;
                <i class="{{ecosystems[ecosystem]["status"]}} fa fa-circle" style="margin-left: auto;"></i>
              </div>
              <div class="boardColumnContainer" style="text-align: left;">
                <div class="boardColumnItem">Light mode: {{light_data[ecosystem]["mode"]}}</div>
                <div class="boardColumnItem">Light status: {{light_data[ecosystem]["status"]}}</div>
                {% if light_data[ecosystem]["mode"] != "NA" %}
                {% if light_data[ecosystem]["method"] == "fixed" %}
                <div class="boardColumnItem">
                  Light: from <span id="lightMorningStart_{{ ecosystem }}"></span>
                  to <span id="lightEveningEnd_{{ ecosystem }}"></span>
                </div>
                {% elif light_data[ecosystem]["method"] == "elongate" %}
                <div class="boardColumnItem">
                  Morning light:
                  {% if light_data[ecosystem]["morning_start"] < light_data[ecosystem]["morning_end"] %}
                  from <span id="lightMorningStart_{{ ecosystem }}"></span>
                  to <span id="lightMorningEnd_{{ ecosystem }}"></span>
                  {% else %}
                  no lighting
                  {% endif %}
                </div>
                <div class="boardColumnItem">
                  Evening light:
                  {% if light_data[ecosystem]["evening_start"] < light_data[ecosystem]["evening_end"] %}
                  from <span id="lightEveningStart_{{ ecosystem }}"></span>
                  to <span id="lightEveningEnd_{{ ecosystem }}"></span>
                  {% else %}
                  no lighting
                  {% endif %}
                </div>
                {% endif %}
                {% endif %}
                <div class="boardColumnItem">Plants: #TODO</div>
              </div>
            </div>
            {% endfor %}
            {% endif %}
          </div>

          <script type="text/javascript">
            $('#today_day').text(formattedDate);

            {% if sun_times %}
            let timeSunrise = new Date("{{ sun_times["sunrise"] }}")
            let timeSunset = new Date("{{ sun_times["sunset"] }}")
            $('#sunrise').text(timeSunrise.toLocaleTimeString());
            $('#sunset').text(timeSunset.toLocaleTimeString());

            socket.on('sun_times', function(msg) {
              timeSunrise = new Date(msg.sunrise)
              timeSunset = new Date(msg.sunset)
              $('#sunrise').text(timeSunrise.toLocaleTimeString());
              $('#sunset').text(timeSunset.toLocaleTimeString());
            });
            {% endif %}

            {% if weather_data %}
            // Weather related spans settings and update event
            $('#weather_summary').text('{{ weather_data["currently"]["summary"] }}');
            $('#weather_temperature').text(Number({{ weather_data["currently"]["temperature"] }}).toFixed(1));
            $('#weather_windSpeed').text(Number( {{weather_data["currently"]["windSpeed"] }}).toFixed(1));
            $('#weather_precipProbability').text(Number({{ weather_data["currently"]["precipProbability"] }} * 100).toFixed(0));
            $('#weather_humidity').text(Number({{ weather_data["currently"]["humidity"] }} * 100).toFixed(0));
            $('#weather_cloudCover').text(Number({{ weather_data["currently"]["cloudCover"] }} * 100).toFixed(0));

            socket.on('current_weather', function(msg) {
              $('#weather_summary').text(msg.summary);
              $('#weather_temperature').text(Number(msg.temperature).toFixed(1));
              $('#weather_windSpeed').text(Number(msg.windSpeed).toFixed(1));
              $('#weather_precipProbability').text(Number(msg.precipProbability * 100).toFixed(0));
              $('#weather_humidity').text(Number(msg.humidity * 100).toFixed(0));
              $('#weather_cloudCover').text(Number(msg.cloudCover * 100).toFixed(0));
            });
            {% endif %}

            {% if current_user.is_administrator %}
            // Server related spans settings and update event
            $('#server_uptime').text('{{ system_data["uptime"] }}');
            $('#server_CPU_used').text(Number({{ system_data["CPU_used"] }}).toFixed(2));
            $('#server_CPU_temp').text(Number({{ system_data["CPU_temp"] }}).toFixed(2));
            $('#server_RAM_used').text(Number({{ system_data["RAM_used"] }}).toFixed(2));
            $('#server_RAM_total').text(Number({{ system_data["RAM_total"] }}).toFixed(2));
            $('#server_DISK_used').text(Number({{ system_data["DISK_used"] }}).toFixed(2));
            $('#server_DISK_total').text(Number({{ system_data["DISK_total"] }}).toFixed(2));

            let server_CPU_used_values = [];

            socketAdmin.on('current_server_data', function(msg) {
              $('#server_uptime').text(msg.uptime);
              $('#server_CPU_temp').text(Number(msg.CPU_temp).toFixed(2));
              $('#server_RAM_used').text(Number(msg.RAM_used).toFixed(2));
              $('#server_RAM_total').text(Number(msg.RAM_total).toFixed(2));
              $('#server_DISK_used').text(Number(msg.DISK_used).toFixed(2));
              $('#server_DISK_total').text(Number(msg.DISK_total).toFixed(2));

              server_CPU_used_values.push(msg.CPU_used)
              server_CPU_used_values = server_CPU_used_values.slice(-5);
              let server_CPU_used_sum = 0;
              for (i = 0; i < server_CPU_used_values.length; i++)
                  server_CPU_used_sum += server_CPU_used_values[i];
              $('#server_CPU_used').text((Math.round(10 * server_CPU_used_sum /
                server_CPU_used_values.length) / 10 ).toFixed(2));
            });
            {% endif %}

            {% for ecosystem in ecosystems %}
            {% if light_data[ecosystem]["mode"] != "NA" %}
            let morningStart_{{ ecosystem }} = new Date(
              "{{ light_data[ecosystem]["morning_start"] }}")
            let eveningEnd_{{ ecosystem }} = new Date(
              "{{ light_data[ecosystem]["evening_end"] }}")
            $('#lightMorningStart_{{ ecosystem }}').text(
              morningStart_{{ ecosystem }}.toLocaleTimeString());
            $('#lightEveningEnd_{{ ecosystem }}').text(
              eveningEnd_{{ ecosystem }}.toLocaleTimeString());

            {% if light_data[ecosystem]["method"] == "elongate" %}
            let morningEnd_{{ ecosystem }} = new Date(
              "{{ light_data[ecosystem]["morning_end"] }}")
            let eveningStart_{{ ecosystem }} = new Date(
              "{{ light_data[ecosystem]["evening_start"] }}")
            $('#lightMorningEnd_{{ ecosystem }}').text(
              morningEnd_{{ ecosystem }}.toLocaleTimeString());
            $('#lightEveningStart_{{ ecosystem }}').text(
              eveningStart_{{ ecosystem }}.toLocaleTimeString());
            {% endif %}
            {% endif %}
            {% endfor %}
          </script>
{% endblock %}